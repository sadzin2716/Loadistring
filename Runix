--[[
   ESP BUTTON (DRAGGABLE) + TEAM CHECK + AUTO UPDATE
   Feito especialmente para você ★
]]

--== UTILIDADES =======================================================--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Guarda highlights criados
local ActiveHighlights = {}

--== FUNÇÃO: Criar Highlight ==========================================--

local function CreateHighlight(player)
    -- Garante que não duplique
    if ActiveHighlights[player] then
        return ActiveHighlights[player]
    end

    -- Verifica se o player tem personagem
    local character = player.Character
    if not character then return end

    -- Cria highlight
    local hl = Instance.new("Highlight")
    hl.FillColor = Color3.fromRGB(255, 255, 255)
    hl.OutlineColor = Color3.fromRGB(255, 255, 255)
    hl.FillTransparency = 1 -- sem preenchimento
    hl.OutlineTransparency = 0
    hl.Adornee = character
    hl.Parent = character

    ActiveHighlights[player] = hl
    return hl
end

--== FUNÇÃO: Remover Highlight ========================================--

local function RemoveHighlight(player)
    if ActiveHighlights[player] then
        ActiveHighlights[player]:Destroy()
        ActiveHighlights[player] = nil
    end
end

--== FUNÇÃO: Verificar se é inimigo ====================================--

local function IsEnemy(player)
    -- Se não existir teams → todos são rivais
    if not player.Team or not LocalPlayer.Team then
        return true
    end

    -- Team diferente = rival
    return player.Team ~= LocalPlayer.Team
end

--== SISTEMA PRINCIPAL DO ESP =========================================--

local ESP_Enabled = false

local function UpdateESP()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then

            -- Se ESP está ligado e é inimigo → cria highlight
            if ESP_Enabled and IsEnemy(player) then
                CreateHighlight(player)
            else
                -- Se desligado → remove
                RemoveHighlight(player)
            end
        end
    end
end

-- Atualiza sempre que personagem renascer
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        task.wait(0.5)
        UpdateESP()
    end)
end)

-- Checa constantemente
RunService.Heartbeat:Connect(UpdateESP)

--== INTERFACE: BOTÃO ARRASTÁVEL ======================================--

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

local Button = Instance.new("TextButton")
Button.Size = UDim2.new(0, 110, 0, 40)
Button.Position = UDim2.new(0.05, 0, 0.2, 0)
Button.Text = "ESP: OFF"
Button.TextScaled = true
Button.Font = Enum.Font.GothamBold
Button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Button.AutoButtonColor = false
Button.Parent = ScreenGui
Button.BackgroundTransparency = 0.15
Button.BorderSizePixel = 0

-- Bordas arredondadas
local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 10)
Corner.Parent = Button

-- Efeito glow
local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(255, 255, 255)
UIStroke.Thickness = 2
UIStroke.Parent = Button

--== ARRASTAR BOTÃO =====================================================--

local dragging = false
local dragStart, startPos

Button.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Button.Position
    end
end)

Button.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        Button.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

--== LÓGICA DO BOTÃO ESP ON/OFF ========================================--

Button.MouseButton1Click:Connect(function()
    ESP_Enabled = not ESP_Enabled

    Button.Text = ESP_Enabled and "ESP: ON" or "ESP: OFF"
    Button.BackgroundColor3 = ESP_Enabled and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(40, 40, 40)

    UpdateESP()
end)
